<html>
<!--
 * You may redistribute this program and/or modify it under the terms of
 * the GNU Lesser General Public License as published by the Free Software
 * Foundation, either version 2.1 of the License, or (at your option) any
 * later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 -->
<head></head>
<body></body>
<script src="/jquery.js"></script>
<script src="/realtime-min.js"></script>
<script src="/sharejs_textarea.js"></script>
<script>

var schedule = function (func) {
    setTimeout(func, /*2 * latency for each node */Math.random() * $('#latency').val());
};

var mkRealtime = function (user, pass, channel, element) {
    var socket = new WebSocket("ws://127.0.0.1:8080/");
    socket.onopen = function(evt) {
        var initState = $(element).val();
        var realtime = Realtime.create(user, pass, channel, initState);
        socket.onmessage = function (evt) { schedule(function () { realtime.message(evt.data); }); };
        realtime.onMessage(function (message) { schedule(function () { socket.send(message); }); });

        attachTextarea($(element)[0], realtime, initState);
        realtime.start();
    };
    socket.onclose = function(evt) { console.log("socket closed"); };
    socket.onerror = function(evt) { console.log("socket error");  };
};

var init = function (element) {
    $.ajax({
        url: '/getToken?cb='+Math.random(),
        success: function (resp) {
            var token = JSON.parse(resp.substring(1));
            mkRealtime(token.user, token.pass, 'abc', element);
        },
        failure: function (err) { throw err; }
    });
};

$(function () {
    init($('#abc'));
    init($('#def'));
});

</script>
<textarea id="abc" cols="60" rows="10"></textarea>
<dl>
  <dt><label for="latency">Average simulated latency</label></dt>
  <dd><input id="latency" value="100"></input></dd>
</dl>
<textarea id="def" cols="60" rows="10"></textarea>
</html>
